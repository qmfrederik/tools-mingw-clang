---
- hosts: all
  tasks:
  - name: Install toolchain
    community.general.pacman:
      name: 
      - git
      - make
      - unzip
      - mingw-w64-x86_64-cmake
      - mingw-w64-x86_64-lld
      - mingw-w64-x86_64-clang
      - mingw-w64-x86_64-cairo
      - mingw-w64-x86_64-freetype
      - mingw-w64-x86_64-gnutls
      - mingw-w64-x86_64-libxslt
      - mingw-w64-x86_64-icu
      - mingw-w64-x86_64-openjpeg2

  - name: Create ~/pkg directory
    ansible.builtin.file:
      path: ~/pkg/
      state: directory
      mode: '0755'

  - name: Create ~/git directory
    ansible.builtin.file:
      path: ~/git/
      state: directory
      mode: '0755'

  # We link only objc/ into /include, as opposed to including /mingw64/lib/gcc/x86_64-w64-mingw32/13.2.0/include,
  # as that would pull in GCC headers which are not compatible with clang
  # Symlink detection doesn't work very well on MSYS2, and stat will report the symlink to be a directory, causing the
  # state: link operation to fail.  Skip the symlink creation if we find a directory
  - name: Install gcc runtime
    community.general.pacman:
      name:
      - mingw-w64-x86_64-gcc-objc
      - mingw-w64-x86_64-libblocksruntime
    when: runtime == "gcc-objc"

  - name: Determine whether /mingw64/include/objc exists
    ansible.builtin.stat:
      path: /mingw64/include/objc
    register: objc_headers

  - name: Link the objc headers into /mingw64/include/
    ansible.builtin.file:
      src: /mingw64/lib/gcc/x86_64-w64-mingw32/13.2.0/include/objc/
      dest: /mingw64/include/objc
      state: link
    when: runtime == "gcc-objc" and objc_headers.stat.islnk is not defined

  # Alternatively, use libobjc2
  - name: Clone libobjc2
    git: 
      repo: "https://github.com/gnustep/libobjc2"
      dest: ~/git/libobjc2
      version: "master"
    when: runtime == "libobjc2"

  - name: Create ~/git/libobjc2/build directory
    ansible.builtin.file:
      path: ~/git/libobjc2/build
      state: directory
      mode: '0755'
    when: runtime == "libobjc2"

  - name: Clone tools-make
    git: 
      repo: "https://github.com/gnustep/tools-make"
      dest: ~/git/tools-make
      version: "make-2_9_1"

  - name: Clone libs-base
    git: 
      repo: "https://github.com/qmfrederik/libs-base"
      dest: ~/git/libs-base
      version: "ucrt64"

  - name: Clone libs-gui
    git: 
      repo: "https://github.com/qmfrederik/libs-gui"
      dest: ~/git/libs-gui
      version: "ucrt64"

  - name: Clone libs-back repository
    git:
      repo: https://github.com/qmfrederik/libs-back
      dest: ~/git/libs-back
      version: "ucrt64"

  - name: Clone plugins-themes-WinUXTheme repository
    git:
      repo: https://github.com/qmfrederik/plugins-themes-WinUXTheme
      dest: ~/git/plugins-themes-WinUXTheme
      version: "ucrt64"

  - name: Create ~/dist directory
    ansible.builtin.file:
      path: ~/dist/
      state: directory
      mode: '0755'
